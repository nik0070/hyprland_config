(()=>{let r=null;const T=(()=>{const r=sessionStorage.getItem("bis_data");return null!==r?JSON.parse(r):null})(),l=T?.config?`${T.id}_t`:null,H=T?.config?.aiMessagesConfig?.CHATGPT||{},{PARSERS:F=[],CHATBOT_NAME:y="",AI_FEATURES:P}=H;window.addEventListener("message",(T=>{"CHATGPT_PROTECTION_STATUS_RESPONSE"===T.data?.type&&(r=T.data.content)})),window.postMessage({posdMessageId:"PANELOS_MESSAGE",posdHash:(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),type:"CHATGPT_PROTECTION_STATUS",from:l,to:l.substring(0,l.length-2),content:""});const X=r=>{try{let T={posdMessageId:"PANELOS_MESSAGE",posdHash:(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),type:"CHATGPT_DATA",from:l,to:l.substring(0,l.length-2),content:r};window.postMessage(T)}catch(r){}},I=function(r,T,l,H){try{if(R(r,T,H.RULES_GET_USER_VALUES),!r?.messageText)return null;_(r,H.MESSAGE_LIMIT||1e4),r.messageType="user",r.creationTime=l}catch(r){}},R=function(r,T,l){for(let H of l)H.PATH?.length?"payload"===H.SOURCE?r[H.NAME]=V.byPath(T,H.PATH):r[H.NAME]=V.byPath(null,H.PATH):H.REDUCE_PARAMS&&(r[H.NAME]=V.byReduce(T,H.REDUCE_PARAMS))},_=function(r,T){let l=r.messageText;"object"==typeof l&&l?.length&&(l=l.reduce(((r,T)=>"object"==typeof T?r:`${r} ${T}`),"")),r.messageText=l.trim().slice(0,T),r.messageLength=r.messageText.length},t=function(T,l,H,F,P){let t={chatbotName:y,messages:[]},D={},M={};if(T?.body?.length){let l=JSON.parse(T.body);R(t,l,P.GENERAL_DATA.GET_BY_PATH),r||I(D,l,H,P.SENT_MESSAGE)}!function(r,T,l){if(!T?.length)return null;try{if(R(r,T,l.RULES_GET_SYSTEM_VALUES),!r?.messageText)return null;r.messageType="system",r.creationTime=null,_(r,l.MESSAGE_LIMIT||3e4)}catch(r){}}(M,F,P.RECEIVED_MESSAGE),D?.messageText&&t.messages.push(D),M?.messageText&&t.messages.push(M),t.sessionId||(t.sessionId=l),t.messages.length&&setTimeout((()=>X(t)),0)},D=async function(r,T,l,H){const F=T.body.getReader(),y=new TextDecoder("utf-8");let P="",X=[],I="";try{for(;;){const{done:r,value:T}=await F.read();if(r)break;P+=y.decode(T,{stream:!0});let l=P.split("\n");for(let r=0;r<l.length;r++){const T=l[r].trim();if(T.startsWith("data:")&&H.RECEIVED_MESSAGE.INVALID_VALUES_TO_PARSE.some((r=>!T.includes(r)))){const r=T.slice(5).trim();try{X.push(JSON.parse(r))}catch(r){}}}I||(I=P.match(new RegExp(H.REGEXP_SESSION_ID_FROM_STREAM))?.groups?.sessionId),P=l[l.length-1]}}catch(r){}finally{t(r,I,l,X,H)}},M={XMLHttpRequest:function(T){const l=self.fetch;self.fetch=async function(H,F={}){const _="string"==typeof H?H:H.url,t=F.method||"GET",M=new Date,V=function(r,T,l){return new RegExp(l.REGEXP_URL_CHECK).test(r)&&T===l.REQUEST_METHOD}(_,t,T);let U;try{if(U=!V||!r||await function(r,T,l){return new Promise((H=>{if(!r?.body?.length)return void H(!0);let F,_=setTimeout((()=>{window.removeEventListener("message",F),H(!0)}),P?.DATA_PROTECTION?.MAX_DELAY_TIMEOUT||3e3),t={chatbotName:y,messages:[],startDelayTime:(new Date).getTime()},D={};try{let y=JSON.parse(r.body);R(t,y,l.GENERAL_DATA.GET_BY_PATH),I(D,y,T,l.SENT_MESSAGE),D?.messageText&&t.messages.push(D),F=function(r){switch(r.data?.type){case"CHATGPT_PROTECTION_CHECK_RESPONSE":case"CHATGPT_PROTECTION_NO_WARNINGS":clearTimeout(_),window.removeEventListener("message",F),H(r.data.result);break;case"CHATGPT_PROTECTION_CLEAR_TIMEOUT":clearTimeout(_)}}.bind(this),window.addEventListener("message",F),X(t)}catch(r){clearTimeout(_),H(!0)}}))}(F,M,T),!U)throw new Error(P?.DATA_PROTECTION?.MESSAGE_ABORTED_REQUEST||"");const H=await l.apply(this,arguments),_=H.clone();return H.ok&&H.body instanceof ReadableStream&&V&&setTimeout(D.bind(this,F,_,M,T),0),H}catch(r){return U?l.apply(this,arguments):new Promise(((T,l)=>{l(r.message)}))}}}},V={byReduce:(r,T)=>{const{KEY:l,CHECK_KEY:H,CHECK_VALUE:F,TYPE:y,RED_FLAG_PATH:P,RED_FLAG_VALUE:X,ALT_PATHS_TO_TEXT:I,ALT_TYPE:R,INVALID_TEXT_VALUES:_,FINISH_VALUE:t,ROLE_CHECK:D,CHECK_STREAM_COMPLETE:M}=T;if(P?.length)for(let T of r){let r=T;for(let T=0;T<P.length;T++){const l=P[T];if(!r[l]){r=null;break}r=r[l]}if(r===X)return null}return r.reduce(((r,T,P,X)=>{if(!T.hasOwnProperty(l))return r;let U=JSON.stringify(T);if(U.includes(D))return r;if(U.includes(M))return X.splice(P),r;if(typeof T[l]===y&&T[l]!==t)return r+=T[l];if(typeof T[l]===R&&!Array.isArray(T[l]))for(let H of I){let F=V.byPath(T[l],H);F&&!_.includes(F)&&(r+=typeof F===y&&F!==t?F:F?.join(""))}if(Array.isArray(T[l]))for(let P of T[l])P[H]===F&&P[l]&&typeof P[l]===y&&P[l]!==t&&(r+=P[l]);return r}),"")},byPath:(r,T)=>{let l=r||self;for(let r=0;r<T.length;r++){const H=T[r];if(!l.hasOwnProperty(H)){l=null;break}l=l[H]}return l}};!function(){for(let r of F)r.USE&&M[r.TYPE](r)}()})();