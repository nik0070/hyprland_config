(()=>{const r=(()=>{const r=sessionStorage.getItem("bis_data");if(null!==r){return JSON.parse(r)}return null})(),T=r?.config?`${r.id}_t`:null,l=r?.config?.aiMessagesConfig?.PERPLEXITY||{},{PARSERS:H=[],CHATBOT_NAME:F=""}=l;let y=!1,P="";const X={XMLHttpRequest:function(r){const T=fetch,l=r=>{let T=r.replace(/.*\/([gimy]*)$/,"$1"),l=r.replace(new RegExp("^/(.*?)/"+T+"$"),"$1");return new RegExp(l,T)};fetch=async function(H,F={}){try{const{SUBSCRIPTION_QUERY:y="",GENERAL_DATA:P={},QUERY:X=""}=r;let _=H instanceof Request?H.url:H;if("object"==typeof _&&_.href&&(_=_.href),l(y).test(_))try{const r=await T.apply(this,arguments);return r.body instanceof ReadableStream&&setTimeout(I.bind(this,r.clone(),P),0),r}catch(r){return T.apply(this,arguments)}if(!l(X).test(_))return T.apply(this,arguments);const t=new Date;try{const l=await T.apply(this,arguments);return l.body instanceof ReadableStream&&setTimeout(R.bind(this,F,t,r,l.clone()),0),l}catch(r){return T.apply(this,arguments)}}catch(r){}}}},I=async(r,T)=>{try{const l=await r.json(),H=M(T.SUBSCRIPTION_VALUE_QUERY,l);y=H===T.SUBSCRIPTION_VALUE}catch(r){y=!1}},R=async(r,T,l,H)=>{const F=H.headers.get("Content-Type")||"";let y="",P="";try{F.includes("text/event-stream")&&(y=t(r.body,l.SEND_MESSAGE)||"",P=await D(H.body,l.RECEIVED_MESSAGE)||"")}catch(r){}finally{_(y,T,P,l)}},_=function(r,T,l,H){let X={chatbotName:F,messages:[]},{eventData:I,receivedMessage:R}=l;const _=self.location.href.split("-");X.sessionId=_[_.length-1],X.subscription=y,X.chatModel=P;let t={},D={};t=V(r,T,H.SEND_MESSAGE?.MESSAGE_LIMIT||1e4,"user"),D=V(R,null,H.RECEIVED_MESSAGE?.MESSAGE_LIMIT||3e4,"system"),t&&X.messages.push(t),D&&X.messages.push(D),X.messages.length&&setTimeout((()=>Q(X)),0)},t=(r="{}",T={})=>{const{MESSAGE_QUERY:l=[],ATTACHMENTS_QUERY:H=[],SOURCE_QUERY:F=[],IGNORED_SOURCES:y=[],MODEL_QUERY:X=[]}=T;if(r){const T=JSON.parse(r),I=M(F,T)||"";if(P=M(X,T)||"",y.includes(I))return"";let R=M(l,T)||"";if(R){const r=M(H,T)||[];r?.length&&r.forEach((r=>{r.includes(R)&&(R="")}))}return R}return""},D=async(r,T={})=>{const{DATA_OBJ_QUERY:l=[],MESSAGE_QUERY:H=[]}=T,F=r.getReader(),y=new TextDecoder("utf-8");let P="";for(;;){const{value:r,done:T}=await F.read();if(T)break;let X;for(P+=y.decode(r,{stream:!0}),P=P.replace(/\r\n/g,"\n");-1!==(X=P.indexOf("\n\n"));){const r=P.slice(0,X).trim();P=P.slice(X+2);const T=r.split("\n"),F={};for(const r of T){const[T,...l]=r.split(":");if(T&&l.length){const r=l.join(":").trim();if("data"===T)try{F.data=JSON.parse(r)}catch{F.data=r}else F[T]=r}}const y=M(l,F);if(y?.length){let r="";if(y.forEach((T=>{const l=M(H,T);l&&(r=l)})),r)return{receivedMessage:r,eventData:F}}}}},M=(r,T)=>r.reduce(((r,T)=>r?"object"==typeof r?r[T]:r:null),T),V=(r,T,l,H)=>{if(r){const F=U(r,T,l,H);if(F)return F}},U=function(r,T,l,H="user"){return{messageType:H,messageId:"",messageLength:r.length,messageText:r.trim().slice(0,l),creationTime:T}},Q=r=>{try{let l={posdMessageId:"PANELOS_MESSAGE",posdHash:(Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)).substring(0,22),type:"PERPLEXITY_DATA",from:T,to:T.substring(0,T.length-2),content:r};window.postMessage(l)}catch(r){}};for(let r of H)r.USE&&X[r.TYPE](r)})();